<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medical Rotation Scheduler</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Day.js for date handling -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/weekOfYear.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/isoWeek.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/customParseFormat.js"></script>
  <!-- Chart.js for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse for CSV export and import -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0fdfa',
              100: '#ccfbf1',
              200: '#99f6e4',
              300: '#5eead4',
              400: '#2dd4bf',
              500: '#14b8a6',
              600: '#0d9488',
              700: '#0f766e',
              800: '#115e59',
              900: '#134e4a',
              950: '#042f2e',
            },
            secondary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
              950: '#082f49',
            },
          },
          animation: {
            'spin-slow': 'spin 3s linear infinite',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>
  <style>
    [x-cloak] { display: none !important; }
    
    /* Loading Animation */
    .loader {
      border-top-color: #0d9488;
      -webkit-animation: spinner 1.5s linear infinite;
      animation: spinner 1.5s linear infinite;
    }
    
    @-webkit-keyframes spinner {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }
    
    @keyframes spinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Modern Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #0d9488;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #14b8a6;
    }
    
    /* Smooth transitions */
    .transition-all {
      transition: all 0.3s ease;
    }
    
    /* Print styles */
    @media print {
      .no-print {
        display: none !important;
      }
      
      .print-only {
        display: block !important;
      }
      
      body {
        font-size: 12px;
      }
    }
    
    /* Modal animation */
    .modal-enter {
      opacity: 0;
      transform: scale(0.95);
    }
    
    .modal-enter-active {
      opacity: 1;
      transform: scale(1);
      transition: opacity 300ms, transform 300ms;
    }
    
    .modal-exit {
      opacity: 1;
      transform: scale(1);
    }
    
    .modal-exit-active {
      opacity: 0;
      transform: scale(0.95);
      transition: opacity 300ms, transform 300ms;
    }
    
    /* Tooltip */
    .tooltip {
      position: relative;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    
    /* Card hover effect */
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    /* Phase grouping in full schedule */
    .phase-group {
      border-left: 4px solid;
    }
    
    .phase-group-M {
      border-color: #3b82f6;
    }
    
    .phase-group-S {
      border-color: #10b981;
    }
    
    .phase-group-O {
      border-color: #8b5cf6;
    }
    
    .phase-group-Misc {
      border-color: #f59e0b;
    }
    
    .phase-group-CM {
      border-color: #ef4444;
    }
    
    /* Calendar view enhancements */
    .calendar-day {
      min-height: 120px;
      transition: all 0.2s ease;
      background-color: white;
    }
    
    .calendar-day:hover {
      background-color: #f0fdfa;
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    .calendar-day.today {
      background-color: #ccfbf1;
      border: 2px solid #14b8a6;
    }
    
    .calendar-header {
      background-color: #0f766e;
      color: white;
      padding: 10px;
      border-radius: 6px 6px 0 0;
    }
    
    /* Glass morphism effect */
    .glass {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    /* Search input styling */
    .search-input {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23999' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' /%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 0.625rem 0.75rem;
      background-size: 1rem;
      padding-left: 2.5rem;
    }

    /* Enhanced loading effects */
    .animate-pulse-slow {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: .5;
      }
    }

    .loader {
      border-top-color: #0d9488;
      -webkit-animation: spinner 1.5s linear infinite;
      animation: spinner 1.5s linear infinite;
    }

    @-webkit-keyframes spinner {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }

    @keyframes spinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .shadow-hover {
      transition: all 0.3s ease;
    }

    .shadow-hover:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-2px);
    }

    /* Enhanced Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 160px;
      background-color: rgba(0, 0, 0, 0.8);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 10;
      bottom: 125%;
      left: 50%;
      margin-left: -80px;
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      transform: translateY(10px);
      font-size: 0.75rem;
      pointer-events: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
      transform: translateY(0);
    }
    
    .tooltip .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
    }

    /* Modern flash loading effect for student data */
    .skeleton-loader {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Alpine.js for reactivity -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js"></script>

  <div x-data="scheduler()" x-init="initialize()" class="min-h-screen flex flex-col">
    <!-- Loading Overlay -->
    <div x-show="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <h2 class="text-xl font-semibold text-primary-700 mb-2" x-text="loadingMessage"></h2>
        <p class="text-gray-600" x-text="loadingSubMessage"></p>
      </div>
    </div>

    <!-- Full Schedule Modal -->
    <div x-show="showFullScheduleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 overflow-auto p-4" 
         x-transition:enter="modal-enter" 
         x-transition:enter-start="opacity-0" 
         x-transition:enter-end="opacity-100" 
         x-transition:leave="modal-exit" 
         x-transition:leave-start="opacity-100" 
         x-transition:leave-end="opacity-0"
         @click.self="showFullScheduleModal = false">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-primary-700 text-white">
          <h2 class="text-xl font-bold" x-text="`Full Schedule for ${getStudentName(selectedStudentId)}`"></h2>
          <button @click="showFullScheduleModal = false" class="text-white hover:text-gray-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-4 overflow-auto flex-grow">
          <div class="overflow-x-auto">
            <template x-for="(phaseGroup, phaseCode) in getFullScheduleByPhase(selectedStudentId)" :key="phaseCode">
              <div :class="`mb-6 phase-group phase-group-${phaseCode} pl-4`">
                <h3 class="text-lg font-semibold mb-2" x-text="getPhaseName(phaseCode)"></h3>
                <table class="min-w-full border-collapse">
                  <thead>
                    <tr>
                      <th class="border px-4 py-2 bg-gray-100">Week</th>
                      <th class="border px-4 py-2 bg-gray-100">Date Range</th>
                      <th class="border px-4 py-2 bg-gray-100">Rotation</th>
                      <th class="border px-4 py-2 bg-gray-100">Sub-Phase</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="(week, index) in phaseGroup" :key="index">
                      <tr :class="{'bg-primary-50': week.isCurrentWeek}">
                        <td class="border px-4 py-2 font-medium" x-text="week.weekNumber"></td>
                        <td class="border px-4 py-2" x-text="week.dateRange"></td>
                        <td class="border px-4 py-2">
                          <div class="tooltip">
                            <div :class="`px-2 py-1 rounded text-xs font-medium inline-block ${getRotationColorClass(week.rotation)}`" 
                                 x-text="week.rotation"></div>
                            <span class="tooltip-text" x-text="getRotationName(week.rotation)"></span>
                          </div>
                        </td>
                        <td class="border px-4 py-2" x-text="getRotationName(week.rotation)"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
          </div>
        </div>
        <div class="p-4 border-t border-gray-200 flex justify-end">
          <button @click="exportStudentScheduleToCSV(selectedStudentId)" class="bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 transition mr-2">
            Export to CSV
          </button>
          <button @click="showFullScheduleModal = false" class="border border-gray-300 px-4 py-2 rounded-md hover:bg-gray-100 transition">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Sub-Phase Students Modal -->
    <div x-show="showSubPhaseStudentsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 overflow-auto p-4" 
         x-transition:enter="modal-enter" 
         x-transition:enter-start="opacity-0" 
         x-transition:enter-end="opacity-100" 
         x-transition:leave="modal-exit" 
         x-transition:leave-start="opacity-100" 
         x-transition:leave-end="opacity-0"
         @click.self="showSubPhaseStudentsModal = false">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-primary-700 text-white">
          <h2 class="text-xl font-bold" x-text="`Students in ${selectedRotation} Rotation`"></h2>
          <button @click="showSubPhaseStudentsModal = false" class="text-white hover:text-gray-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-4 overflow-auto flex-grow">
          <div class="mb-4">
            <input 
              type="text" 
              x-model="subPhaseStudentSearch" 
              placeholder="Search by name or registration number" 
              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 search-input"
            >
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full border-collapse">
              <thead>
                <tr>
                  <th class="border px-4 py-2 bg-gray-100">Reg. No.</th>
                  <th class="border px-4 py-2 bg-gray-100">Name</th>
                  <th class="border px-4 py-2 bg-gray-100">Batch</th>
                  <th class="border px-4 py-2 bg-gray-100">Start Date</th>
                  <th class="border px-4 py-2 bg-gray-100">End Date</th>
                  <th class="border px-4 py-2 bg-gray-100">Actions</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="student in getFilteredSubPhaseStudents()" :key="student.id">
                  <tr class="hover:bg-gray-50 transition-all">
                    <td class="border px-4 py-2 font-medium" x-text="student.regdNo"></td>
                    <td class="border px-4 py-2" x-text="student.name"></td>
                    <td class="border px-4 py-2" x-text="student.batch"></td>
                    <td class="border px-4 py-2" x-text="formatDate(student.startDate)"></td>
                    <td class="border px-4 py-2" x-text="formatDate(student.endDate)"></td>
                    <td class="border px-4 py-2">
                      <button @click="viewFullSchedule(student.id)" class="bg-primary-600 text-white px-2 py-1 rounded text-xs hover:bg-primary-700 transition shadow-sm hover:shadow">
                        View Full Schedule
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
        <div class="p-4 border-t border-gray-200 flex justify-end">
          <button @click="showSubPhaseStudentsModal = false" class="border border-gray-300 px-4 py-2 rounded-md hover:bg-gray-100 transition">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-primary-800 to-primary-950 text-white shadow-lg">
      <div class="container mx-auto px-4 py-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="flex items-center mb-2 md:mb-0">
            <div class="bg-white p-1 rounded-full mr-3 w-12 h-12 flex items-center justify-center">
              <img src="https://gimsr.gitam.edu/Images/gimsr-image-ivory.svg" alt="Logo" class="rounded-full" />
            </div>
            <div>
              <h1 class="text-2xl font-bold">Medical Rotation Scheduler</h1>
              <p class="text-xs text-primary-100">Streamline your medical rotation management</p>
            </div>
          </div>
          <div class="flex space-x-2">
            <button @click="prepareAndExportToCSV()" class="bg-white text-primary-700 px-4 py-2 rounded-md hover:bg-gray-100 transition flex items-center shadow-md">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
              Export Data
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 flex-grow">
      <!-- Filters -->
      <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-primary-700 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            Filters
          </h2>
          <div class="flex items-center">
            <button @click="toggleFilters()" class="text-primary-700 hover:text-primary-500 transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" :class="{'rotate-180': !showFilters}">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
          </div>
        </div>
        <div x-show="showFilters" x-collapse>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Batch</label>
              <select x-model="filters.batch" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
                <option value="all">All Batches</option>
                <option value="A">Batch A</option>
                <option value="B">Batch B</option>
                <option value="C">Batch C</option>
                <option value="D">Batch D</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Phase</label>
              <select x-model="filters.phase" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
                <option value="all">All Phases</option>
                <option value="M">Medicine</option>
                <option value="S">Surgery</option>
                <option value="O">OBGY</option>
                <option value="Misc">Misc</option>
                <option value="CM">Community Medicine</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
              <div class="flex space-x-2">
                <input type="date" x-model="filters.startDate" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
                <input type="date" x-model="filters.endDate" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
              </div>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Student</label>
              <div class="relative">
                <input 
                  type="text" 
                  x-model="studentSearchQuery" 
                  placeholder="Search by name or reg. no." 
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500 search-input"
                >
                <div x-show="studentSearchLoading" class="absolute inset-y-0 right-3 flex items-center">
                  <div class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-4 w-4"></div>
                </div>
                <div x-show="studentSearchResults.length > 0 && studentSearchQuery.length > 0" class="absolute z-10 w-full mt-1 bg-white shadow-lg rounded-md max-h-60 overflow-auto">
                  <template x-for="student in studentSearchResults" :key="student.id">
                    <div 
                      @click="selectStudent(student.id)" 
                      class="px-4 py-2 hover:bg-primary-50 cursor-pointer"
                    >
                      <div class="font-medium" x-text="student.regdNo"></div>
                      <div class="text-sm text-gray-600" x-text="student.name"></div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Rotation</label>
              <select x-model="filters.rotation" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
                <option value="all">All Rotations</option>
                <option value="GM">General Medicine</option>
                <option value="PY">Psychiatry</option>
                <option value="CA">Casualty</option>
                <option value="EN">ENT</option>
                <option value="GS">General Surgery</option>
                <option value="AN">Anesthesia</option>
                <option value="OR">Orthopedics</option>
                <option value="OP">Ophthalmology</option>
                <option value="OB">Obstetrics</option>
                <option value="PE">Pediatrics</option>
                <option value="RM">Respiratory</option>
                <option value="RA">Radiology</option>
                <option value="DE">Dermatology</option>
                <option value="YO">YO</option>
                <option value="FP">FP</option>
                <option value="LM">LM</option>
                <option value="FM">FM</option>
                <option value="CH">CH</option>
                <option value="PH">PH</option>
                <option value="UH">UH</option>
                <option value="RH">RH</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Set Current Date</label>
              <div class="flex space-x-2">
                <input type="date" x-model="jumpToDate" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
                <button @click="jumpToSelectedDate()" class="bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 transition shadow-sm hover:shadow">
                  Set Date
                </button>
              </div>
            </div>
          </div>
          <div class="mt-4">
            <button @click="applyFilters()" class="bg-primary-600 text-white px-4 py-2 rounded-md hover:bg-primary-700 transition shadow-sm hover:shadow">
              Apply Filters
            </button>
            <button @click="resetFilters()" class="ml-2 border border-primary-600 text-primary-600 px-4 py-2 rounded-md hover:bg-primary-50 transition">
              Reset
            </button>
          </div>
        </div>
      </div>

      <!-- View Type Selector -->
      <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex flex-wrap gap-2">
          <button @click="viewType = 'dashboard'" :class="`px-4 py-2 rounded-md transition flex items-center ${viewType === 'dashboard' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
            Dashboard
          </button>
          <button @click="viewType = 'calendar'" :class="`px-4 py-2 rounded-md transition flex items-center ${viewType === 'calendar' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
            </svg>
            Calendar
          </button>
          <button @click="viewType = 'student'" :class="`px-4 py-2 rounded-md transition flex items-center ${viewType === 'student' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
            </svg>
            Students
          </button>
          <button @click="viewType = 'rotation'" :class="`px-4 py-2 rounded-md transition flex items-center ${viewType === 'rotation' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 2h10v10H5V5z" />
            </svg>
            Rotations
          </button>
          <button @click="viewType = 'batch'" :class="`px-4 py-2 rounded-md transition flex items-center ${viewType === 'batch' ? 'bg-primary-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
            </svg>
            Batches
          </button>
        </div>
      </div>

      <!-- Dashboard View -->
      <div x-show="viewType === 'dashboard'">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-all card-hover">
            <h3 class="text-lg font-semibold text-gray-700">Total Students</h3>
            <p class="text-3xl font-bold text-primary-600 mt-2" x-text="students.length"></p>
            <div class="mt-2 text-sm text-gray-500">Across all batches</div>
          </div>
          <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-all card-hover">
            <h3 class="text-lg font-semibold text-gray-700">Active Rotations</h3>
            <p class="text-3xl font-bold text-primary-600 mt-2" x-text="getActiveRotationsCount()"></p>
            <div class="mt-2 text-sm text-gray-500">Currently in progress</div>
          </div>
          <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-all card-hover">
            <h3 class="text-lg font-semibold text-gray-700">Current Week</h3>
            <p class="text-3xl font-bold text-primary-600 mt-2" x-text="getCurrentWeek()"></p>
            <div class="mt-2 text-sm text-gray-500">Of 53 total weeks</div>
          </div>
          <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-all card-hover">
            <h3 class="text-lg font-semibold text-gray-700">Completion</h3>
            <div class="mt-2 h-4 bg-gray-200 rounded-full overflow-hidden">
              <div class="h-full bg-primary-600 transition-all" :style="`width: ${getCompletionPercentage()}%`"></div>
            </div>
            <p class="text-sm text-gray-600 mt-1" x-text="`${getCompletionPercentage()}% Complete`"></p>
          </div>
        </div>

        <!-- Batch Overview -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
          <h2 class="text-xl font-semibold text-primary-700 mb-4 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
            Batch Overview
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <template x-for="batch in ['A', 'B', 'C', 'D']" :key="batch">
              <div class="border rounded-lg p-4 hover:border-primary-500 transition-all">
                <div class="flex justify-between items-center mb-2">
                  <h3 class="text-lg font-semibold" x-text="`Batch ${batch}`"></h3>
                  <span class="bg-primary-600 text-white text-xs px-2 py-1 rounded-full" x-text="getStudentCountInBatch(batch)"></span>
                </div>
                <div class="mb-2">
                  <span class="text-sm text-gray-500">Current Phase:</span>
                  <span class="font-medium" x-text="getCurrentPhaseForBatch(batch).phase"></span>
                </div>
                <div class="mb-2">
                  <span class="text-sm text-gray-500">Date Range:</span>
                  <div class="font-medium">
                    <span x-text="formatDate(getCurrentPhaseForBatch(batch).startDate)"></span> - 
                    <span x-text="formatDate(getCurrentPhaseForBatch(batch).endDate)"></span>
                  </div>
                </div>
                <div>
                  <span class="text-sm text-gray-500">Next Phase:</span>
                  <span class="font-medium" x-text="getNextPhaseForBatch(batch) ? getNextPhaseForBatch(batch).phase : 'None'"></span>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Current Rotations -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
          <h2 class="text-xl font-semibold text-primary-700 mb-4 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Current Rotations
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <template x-for="rotation in getActiveRotations().slice(0, 6)" :key="rotation.id">
              <div class="border rounded-lg p-4 hover:border-primary-500 transition-all">
                <div class="flex justify-between items-center mb-2">
                  <div>
                    <span :class="`px-2 py-1 rounded text-xs font-medium inline-block ${getRotationColorClass(rotation.code)}`" 
                         x-text="rotation.code"></span>
                    <span class="ml-2 font-medium" x-text="rotation.name"></span>
                  </div>
                  <span class="bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full" x-text="rotation.studentCount"></span>
                </div>
                <div class="mb-2">
                  <span class="text-sm text-gray-500">Phase:</span>
                  <span class="font-medium" x-text="rotation.phase"></span>
                </div>
                <div class="text-sm text-gray-500">
                  <span x-text="formatDate(rotation.startDate)"></span> - 
                  <span x-text="formatDate(rotation.endDate)"></span>
                </div>
                <div class="mt-2">
                  <button 
                    @click="viewStudentsInRotation(rotation.code)" 
                    class="bg-primary-600 text-white px-2 py-1 rounded text-xs hover:bg-primary-700 transition shadow-sm hover:shadow"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    View Students
                  </button>
                </div>
              </div>
            </template>
          </div>
          <div class="mt-4 text-right">
            <button @click="viewType = 'rotation'" class="text-primary-600 hover:text-primary-800 transition flex items-center ml-auto">
              View all rotations
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Quick Access -->
        <div class="bg-white rounded-lg shadow-md p-4">
          <h2 class="text-xl font-semibold text-primary-700 mb-4 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Quick Access
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div @click="viewType = 'calendar'" class="border rounded-lg p-4 hover:border-primary-500 transition-all cursor-pointer card-hover">
              <div class="flex items-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <h3 class="text-lg font-semibold">Calendar View</h3>
              </div>
              <p class="text-gray-600">View weekly rotation schedule for all students</p>
            </div>
            <div @click="viewType = 'student'" class="border rounded-lg p-4 hover:border-primary-500 transition-all cursor-pointer card-hover">
              <div class="flex items-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <h3 class="text-lg font-semibold">Student View</h3>
              </div>
              <p class="text-gray-600">View current and upcoming rotations for each student</p>
            </div>
            <div @click="viewType = 'batch'" class="border rounded-lg p-4 hover:border-primary-500 transition-all cursor-pointer card-hover">
              <div class="flex items-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                <h3 class="text-lg font-semibold">Batch View</h3>
              </div>
              <p class="text-gray-600">View phase information for each batch</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Schedule Visualization -->
      <div x-show="viewType !== 'dashboard'" class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-primary-700 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            Schedule Visualization
          </h2>
          <div x-show="['calendar', 'student', 'rotation'].includes(viewType)" class="flex space-x-2">
            <button @click="previousWeek()" class="bg-gray-200 px-3 py-1 rounded-md hover:bg-gray-300 transition flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
              Previous
            </button>
            <span class="px-3 py-1 bg-primary-50 rounded-md" x-text="formatDateRange(currentViewStartDate, currentViewEndDate)"></span>
            <button @click="nextWeek()" class="bg-gray-200 px-3 py-1 rounded-md hover:bg-gray-300 transition flex items-center">
              Next
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Calendar View -->
        <div x-show="viewType === 'calendar'" class="overflow-x-auto">
          <div x-show="calendarLoading" class="flex justify-center items-center py-12">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
          </div>
          <div x-show="!calendarLoading" class="mb-4">
            <div class="grid grid-cols-7 gap-2">
              <div class="calendar-header p-2 text-center rounded-t-md font-semibold">Sun</div>
              <div class="calendar-header p-2 text-center font-semibold">Mon</div>
              <div class="calendar-header p-2 text-center font-semibold">Tue</div>
              <div class="calendar-header p-2 text-center font-semibold">Wed</div>
              <div class="calendar-header p-2 text-center font-semibold">Thu</div>
              <div class="calendar-header p-2 text-center font-semibold">Fri</div>
              <div class="calendar-header p-2 text-center rounded-t-md font-semibold">Sat</div>
              
              <template x-for="date in getCurrentWeekDates()" :key="date.format('YYYY-MM-DD')">
                <div :class="`calendar-day border rounded-lg shadow-sm p-3 ${isToday(date) ? 'today' : ''}`">
                  <div class="flex justify-between items-center mb-3 pb-2 border-b">
                    <span class="font-bold text-lg" x-text="date.format('D')"></span>
                    <span class="text-xs px-2 py-1 bg-primary-100 text-primary-800 rounded-full" x-text="date.format('MMM')"></span>
                  </div>
                  <div class="space-y-2 max-h-[300px] overflow-y-auto">
                    <template x-for="student in getStudentsForDate(date)" :key="student.id">
                      <div class="text-xs p-2 rounded-md bg-gray-50 hover:bg-gray-100 transition-all border border-gray-200 shadow-sm">
                        <div class="font-medium" x-text="student.regdNo"></div>
                        <div class="flex justify-between items-center mt-1">
                          <span class="truncate" x-text="student.name"></span>
                          <div class="tooltip">
                            <span :class="`px-1.5 py-0.5 rounded text-xs ${getRotationColorClass(student.rotation)}`" x-text="student.rotation"></span>
                            <span class="tooltip-text" x-text="getRotationName(student.rotation)"></span>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>
          
          <div x-show="!calendarLoading" class="mt-6">
            <h3 class="text-lg font-semibold text-primary-700 mb-2">Weekly Rotation Summary</h3>
            <table class="min-w-full border-collapse">
              <thead>
                <tr>
                  <th class="border px-4 py-2 bg-gray-100">Reg. No.</th>
                  <th class="border px-4 py-2 bg-gray-100">Student</th>
                  <th class="border px-4 py-2 bg-gray-100">Batch</th>
                  <th class="border px-4 py-2 bg-gray-100">Rotation</th>
                  <th class="border px-4 py-2 bg-gray-100">Sub-Phase</th>
                  <th class="border px-4 py-2 bg-gray-100">Actions</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="student in getFilteredStudents()" :key="student.id">
                  <tr class="hover:bg-gray-50 transition-all">
                    <td class="border px-4 py-2 font-medium" x-text="student.regdNo"></td>
                    <td class="border px-4 py-2" x-text="student.name"></td>
                    <td class="border px-4 py-2" x-text="student.batch"></td>
                    <td class="border px-4 py-2">
                      <template x-if="getStudentRotationForWeek(student.id, currentViewStartDate)">
                        <div :class="`px-2 py-1 rounded text-xs font-medium ${getRotationColorClass(getStudentRotationForWeek(student.id, currentViewStartDate).rotation)}`" 
                             x-text="getStudentRotationForWeek(student.id, currentViewStartDate).rotation"></div>
                      </template>
                    </td>
                    <td class="border px-4 py-2">
                      <template x-if="getStudentRotationForWeek(student.id, currentViewStartDate)">
                        <span x-text="getRotationName(getStudentRotationForWeek(student.id, currentViewStartDate).rotation)"></span>
                      </template>
                    </td>
                    <td class="border px-4 py-2">
                      <button @click="viewFullSchedule(student.id)" class="bg-primary-600 text-white px-2 py-1 rounded text-xs hover:bg-primary-700 transition shadow-sm hover:shadow">
                        View Full Schedule
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Student View -->
        <div x-show="viewType === 'student'" class="overflow-x-auto">
          <div x-show="studentViewLoading" class="flex justify-center items-center py-12">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
          </div>
          
          <div x-show="!studentViewLoading" class="mb-4">
            <div class="relative mb-6">
              <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <input 
                type="text" 
                x-model="studentListSearch" 
                placeholder="Search by name or registration number" 
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all shadow-sm"
              >
              <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                <div x-show="studentListSearch.length > 0" @click="studentListSearch = ''" class="cursor-pointer text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </div>
              </div>
            </div>
          </div>
          
          <div x-show="studentViewLoading" class="space-y-4 mt-4">
            <template x-for="i in 5">
              <div class="flex items-center space-x-4">
                <div class="h-8 bg-gray-200 rounded w-1/6 skeleton-loader"></div>
                <div class="h-8 bg-gray-200 rounded w-1/4 skeleton-loader"></div>
                <div class="h-8 bg-gray-200 rounded w-1/6 skeleton-loader"></div>
                <div class="h-8 bg-gray-200 rounded w-1/6 skeleton-loader"></div>
                <div class="h-8 bg-gray-200 rounded w-1/6 skeleton-loader"></div>
              </div>
            </template>
          </div>
          
          <table x-show="!studentViewLoading" class="min-w-full border-collapse">
            <thead>
              <tr>
                <th class="border px-4 py-2 bg-gray-100">Reg. No.</th>
                <th class="border px-4 py-2 bg-gray-100">Student</th>
                <th class="border px-4 py-2 bg-gray-100">Batch</th>
                <th class="border px-4 py-2 bg-gray-100">Current Rotation</th>
                <th class="border px-4 py-2 bg-gray-100">Start Date</th>
                <th class="border px-4 py-2 bg-gray-100">End Date</th>
                <th class="border px-4 py-2 bg-gray-100">Next Rotation</th>
                <th class="border px-4 py-2 bg-gray-100">Actions</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="student in filteredStudents" :key="student.id">
                <tr class="hover:bg-gray-50 transition-all">
                  <td class="border px-4 py-2 font-medium" x-text="student.regdNo"></td>
                  <td class="border px-4 py-2" x-text="student.name"></td>
                  <td class="border px-4 py-2" x-text="student.batch"></td>
                  <td class="border px-4 py-2">
                    <div :class="`px-2 py-1 rounded text-xs font-medium inline-block ${getRotationColorClass(getCurrentRotationForStudent(student.id).rotation)}`" 
                         x-text="getCurrentRotationForStudent(student.id).rotation"></div>
                  </td>
                  <td class="border px-4 py-2" x-text="formatDate(getCurrentRotationForStudent(student.id).startDate)"></td>
                  <td class="border px-4 py-2" x-text="formatDate(getCurrentRotationForStudent(student.id).endDate)"></td>
                  <td class="border px-4 py-2">
                    <template x-if="getNextRotationForStudent(student.id)">
                      <div :class="`px-2 py-1 rounded text-xs font-medium inline-block ${getRotationColorClass(getNextRotationForStudent(student.id).rotation)}`
                         x-text="getNextRotationForStudent(student.id).rotation"></div>
                    </template>
                    <template x-if="!getNextRotationForStudent(student.id)">
                      <span class="text-gray-500">None</span>
                    </template>
                  </td>
                  <td class="border px-4 py-2">
                    <button @click="viewFullSchedule(student.id)" class="bg-primary-600 text-white px-2 py-1 rounded text-xs hover:bg-primary-700 transition shadow-sm hover:shadow">
                      View Full Schedule
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- Rotation View -->
        <div x-show="viewType === 'rotation'" class="overflow-x-auto">
          <div x-show="rotationViewLoading" class="flex justify-center items-center py-12">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
          </div>
          <table x-show="!rotationViewLoading" class="min-w-full border-collapse">
            <thead>
              <tr>
                <th class="border px-4 py-2 bg-gray-100">Rotation</th>
                <th class="border px-4 py-2 bg-gray-100">Phase</th>
                <th class="border px-4 py-2 bg-gray-100">Current Students</th>
                <th class="border px-4 py-2 bg-gray-100">Start Date</th>
                <th class="border px-4 py-2 bg-gray-100">End Date</th>
                <th class="border px-4 py-2 bg-gray-100">Actions</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="rotation in getAllRotations()" :key="rotation.id">
                <tr class="hover:bg-gray-50 transition-all">
                  <td class="border px-4 py-2">
                    <div class="flex items-center">
                      <div :class="`px-2 py-1 rounded text-xs font-medium inline-block ${getRotationColorClass(rotation.code)}`" 
                           x-text="rotation.code"></div>
                      <span class="ml-2" x-text="rotation.name"></span>
                    </div>
                  </td>
                  <td class="border px-4 py-2" x-text="rotation.phase"></td>
                  <td class="border px-4 py-2">
                    <template x-if="rotation.studentCount > 0">
                      <div class="flex flex-wrap gap-1">
                        <template x-for="(student, index) in getStudentsInRotation(rotation.code).slice(0, 3)" :key="student.id">
                          <span class="bg-gray-200 px-2 py-1 rounded text-xs tooltip">
                            <span x-text="student.regdNo"></span>
                            <span class="tooltip-text" x-text="student.name"></span>
                          </span>
                        </template>
                        <template x-if="getStudentsInRotation(rotation.code).length > 3">
                          <span class="bg-gray-200 px-2 py-1 rounded text-xs">
                            +<span x-text="getStudentsInRotation(rotation.code).length - 3"></span> more
                          </span>
                        </template>
                      </div>
                    </template>
                    <template x-if="rotation.studentCount === 0">
                      <span class="text-gray-500 italic">No students currently assigned</span>
                    </template>
                  </td>
                  <td class="border px-4 py-2" x-text="formatDate(rotation.startDate)"></td>
                  <td class="border px-4 py-2" x-text="formatDate(rotation.endDate)"></td>
                  <td class="border px-4 py-2">
                    <button 
                      @click="viewStudentsInRotation(rotation.code)" 
                      class="bg-primary-600 text-white px-2 py-1 rounded text-xs hover:bg-primary-700 transition shadow-sm hover:shadow"
                      :disabled="rotation.studentCount === 0"
                      :class="{'opacity-50 cursor-not-allowed': rotation.studentCount === 0}"
                    >
                      View Students
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- Batch View -->
        <div x-show="viewType === 'batch'" class="overflow-x-auto">
          <div x-show="batchViewLoading" class="flex justify-center items-center py-12">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
          </div>
          <table x-show="!batchViewLoading" class="min-w-full border-collapse">
            <thead>
              <tr>
                <th class="border px-4 py-2 bg-gray-100">Batch</th>
                <th class="border px-4 py-2 bg-gray-100">Current Phase</th>
                <th class="border px-4 py-2 bg-gray-100">Students</th>
                <th class="border px-4 py-2 bg-gray-100">Start Date</th>
                <th class="border px-4 py-2 bg-gray-100">End Date</th>
                <th class="border px-4 py-2 bg-gray-100">Next Phase</th>
                <th class="border px-4 py-2 bg-gray-100">Actions</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="batch in ['A', 'B', 'C', 'D']" :key="batch">
                <tr class="hover:bg-gray-50 transition-all">
                  <td class="border px-4 py-2 font-medium" x-text="`Batch ${batch}`"></td>
                  <td class="border px-4 py-2" x-text="getCurrentPhaseForBatch(batch).phase"></td>
                  <td class="border px-4 py-2" x-text="getStudentCountInBatch(batch)"></td>
                  <td class="border px-4 py-2" x-text="formatDate(getCurrentPhaseForBatch(batch).startDate)"></td>
                  <td class="border px-4 py-2" x-text="formatDate(getCurrentPhaseForBatch(batch).endDate)"></td>
                  <td class="border px-4 py-2" x-text="getNextPhaseForBatch(batch) ? getNextPhaseForBatch(batch).phase : 'None'"></td>
                  <td class="border px-4 py-2">
                    <button 
                      @click="viewBatchStudents(batch)" 
                      class="bg-primary-600 text-white px-2 py-1 rounded text-xs hover:bg-primary-700 transition shadow-sm hover:shadow"
                    >
                      View Students
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-primary-800 to-primary-950 text-white py-6 mt-8">
      <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="flex items-center mb-4 md:mb-0">
            <div class="bg-white p-1 rounded-full mr-3 w-12 h-12 flex items-center justify-center">
              <img src="https://gimsr.gitam.edu/Images/gimsr-image-ivory.svg" alt="Logo" class="rounded-full" />
            </div>
            <div>
              <h2 class="text-lg font-bold">Medical Rotation Scheduler</h2>
              <p class="text-xs text-primary-100">© 2025 All Rights Reserved</p>
            </div>
          </div>
          <div class="text-center md:text-right">
            <p class="text-sm">Developed and managed by 
              <a href="https:/jaswanthmadiya.tech" target="_blank" class="font-bold hover:underline">Madiya Jaswanth</a>
            </p>
            <!-- <p class="text-xs text-primary-100 mt-1">Version 2.0</p> -->
          </div>
        </div>
      </div>
    </footer>

    <!-- Export Loading Modal -->
    <div x-show="showExportLoadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center max-w-md w-full">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <h2 class="text-xl font-semibold text-primary-700 mb-2">Preparing Your Data</h2>
        <p class="text-gray-600 text-center mb-4">Please wait while we format and prepare your data for export...</p>
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
          <div class="bg-primary-600 h-2.5 rounded-full animate-pulse-slow" style="width: 100%"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize dayjs plugins
    dayjs.extend(window.dayjs_plugin_weekOfYear);
    dayjs.extend(window.dayjs_plugin_isoWeek);
    dayjs.extend(window.dayjs_plugin_customParseFormat);

    function scheduler() {
      return {
        students: [],
        schedule: [],
        rotations: [],
        phases: [],
        batchPhases: {},
        
        // Filters
        filters: {
          batch: 'all',
          phase: 'all',
          rotation: 'all',
          student: 'all',
          startDate: '',
          endDate: ''
        },
        
        // View settings
        viewType: 'dashboard',
        currentViewStartDate: null,
        currentViewEndDate: null,
        jumpToDate: '',
        showFilters: true,
        
        // Search and filter
        studentSearchQuery: '',
        studentSearchResults: [],
        studentListSearch: '',
        subPhaseStudentSearch: '',
        
        // Loading states
        loading: true,
        loadingMessage: 'Initializing...',
        loadingSubMessage: 'Please wait while we set up the scheduler',
        calendarLoading: false,
        studentViewLoading: false,
        rotationViewLoading: false,
        batchViewLoading: false,
        studentSearchLoading: false,
        dataLoading: false,
        
        // Modals
        showFullScheduleModal: false,
        showSubPhaseStudentsModal: false,
        selectedStudentId: null,
        selectedRotation: null,

        // Export loading
        showExportLoadingModal: false,

        // Filtered Students
        filteredStudents: [],
        
        // Store original today date
        originalToday: null,
        customToday: null,
        
        async initialize() {
          // Set initial date range
          const startDate = dayjs('2025-04-01');
          this.currentViewStartDate = startDate;
          this.currentViewEndDate = startDate.add(6, 'day');
          
          this.filters.startDate = startDate.format('YYYY-MM-DD');
          this.filters.endDate = startDate.add(52, 'week').format('YYYY-MM-DD');
          this.jumpToDate = dayjs().format('YYYY-MM-DD');
          
          // Store original today function
          this.originalToday = dayjs;
          this.customToday = null;
          
          // Initialize data
          this.loadingMessage = 'Loading student data...';
          await this.loadStudentsFromCSV();
          
          this.loadingMessage = 'Defining rotations...';
          this.defineRotations();
          
          this.loadingMessage = 'Defining phases...';
          this.definePhases();
          
          this.loadingMessage = 'Setting up batch phases...';
          this.defineBatchPhases();
          
          this.loadingMessage = 'Generating schedule...';
          this.generateSchedule();
          
          // Initialize filtered students
          this.filteredStudents = this.getFilteredStudents();
          
          // Finish loading
          this.loadingMessage = 'Ready!';
          this.loadingSubMessage = 'Loading complete';
          setTimeout(() => {
            this.loading = false;
          }, 500);
          
          // Set up watchers
          this.$watch('studentSearchQuery', (value) => {
            if (value.length > 1) {
              this.studentSearchLoading = true;
              setTimeout(() => {
                this.studentSearchResults = this.students.filter(student => 
                  student.name.toLowerCase().includes(value.toLowerCase()) || 
                  student.regdNo.toLowerCase().includes(value.toLowerCase())
                ).slice(0, 10);
                this.studentSearchLoading = false;
              }, 300);
            } else {
              this.studentSearchResults = [];
            }
          });
          
          // Watch for student list search changes
          this.$watch('studentListSearch', async () => {
            this.filteredStudents = await this.getFilteredStudentsList();
          });
          
          // Initial load of filtered students
          this.filteredStudents = await this.getFilteredStudentsList();
        },
        
        // Data loading functions
        async loadStudentsFromCSV() {
          try {
            this.dataLoading = true;
            this.loadingSubMessage = 'Fetching student data from CSV...';
            // const response = await fetch('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/students_with_batches-tv4kpvt1mYqOckOvxTNzZ96H2Q9Bp1.csv');
            const response = await fetch('https://raw.githubusercontent.com/jaswanth070/GIMSR-WEB-APP/refs/heads/main/students_with_batches.csv');
            const csvData = await response.text();
            
            this.loadingSubMessage = 'Parsing student data...';
            const results = Papa.parse(csvData, {
              header: true,
              skipEmptyLines: true
            });
            
            this.students = [];
            
            // Process the CSV data
            results.data.forEach((row, index) => {
              const regdNo = row['Regd. No.'];
              const name = row['Name of the student'];
              const batch = row['Batch'];
              
              if (regdNo && name && batch) {
                this.students.push({
                  id: `${batch}${String(index + 1).padStart(2, '0')}`,
                  regdNo: regdNo,
                  name: name,
                  batch: batch
                });
              }
            });
            
            // Ensure we have exactly 34 students per batch
            const batches = ['A', 'B', 'C', 'D'];
            batches.forEach(batch => {
              const batchStudents = this.students.filter(s => s.batch === batch);
              
              // If we have less than 34 students in a batch, add placeholder students
              if (batchStudents.length < 34) {
                for (let i = batchStudents.length + 1; i <= 34; i++) {
                  this.students.push({
                    id: `${batch}${String(i).padStart(2, '0')}`,
                    regdNo: `PLACEHOLDER-${batch}${i}`,
                    name: `Placeholder Student ${batch}${i}`,
                    batch: batch
                  });
                }
              }
              
              // If we have more than 34 students in a batch, remove excess students
              if (batchStudents.length > 34) {
                const excessCount = batchStudents.length - 34;
                const excessStudents = batchStudents.slice(-excessCount);
                this.students = this.students.filter(s => !excessStudents.includes(s));
              }
            });
            
            this.loadingSubMessage = `Loaded ${this.students.length} students`;
            this.dataLoading = false;
          } catch (error) {
            console.error('Error loading students from CSV:', error);
            this.loadingSubMessage = 'Error loading student data. Generating random data instead.';
            
            // Fallback to random data generation
            this.generateStudents();
            this.dataLoading = false;
          }
        },
        
        // Data generation functions
        generateStudents() {
          const firstNames = ['John', 'Jane', 'Michael', 'Emily', 'David', 'Sarah', 'James', 'Emma', 'Robert', 'Olivia', 'William', 'Sophia', 'Joseph', 'Ava', 'Thomas', 'Isabella', 'Charles', 'Mia', 'Daniel', 'Charlotte'];
          const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Miller', 'Davis', 'Garcia', 'Rodriguez', 'Wilson', 'Martinez', 'Anderson', 'Taylor', 'Thomas', 'Hernandez', 'Moore', 'Martin', 'Jackson', 'Thompson', 'White'];
          
          const batches = ['A', 'B', 'C', 'D'];
          this.students = [];
          
          // Generate 34 students for each batch (136 total)
          for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
            const batch = batches[batchIndex];
            
            for (let i = 1; i <= 34; i++) {
              const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
              const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
              
              this.students.push({
                id: `${batch}${i.toString().padStart(2, '0')}`,
                regdNo: `12201610${batch}${i.toString().padStart(3, '0')}`,
                name: `${firstName} ${lastName}`,
                batch: batch
              });
            }
          }
        },
        
        defineRotations() {
          // Define all possible rotations
          this.rotations = [
            { code: 'GM', name: 'General Medicine', phase: 'M' },
            { code: 'PY', name: 'Psychiatry', phase: 'M' },
            { code: 'CA', name: 'Casualty', phase: 'M' },
            { code: 'EN', name: 'ENT', phase: 'M' },
            
            { code: 'GS', name: 'General Surgery', phase: 'S' },
            { code: 'AN', name: 'Anesthesia', phase: 'S' },
            { code: 'OR', name: 'Orthopedics', phase: 'S' },
            { code: 'OP', name: 'Ophthalmology', phase: 'S' },
            
            { code: 'OB', name: 'Obstetrics', phase: 'O' },
            { code: 'PE', name: 'Pediatrics', phase: 'O' },
            { code: 'RM', name: 'Respiratory Medicine', phase: 'O' },
            { code: 'RA', name: 'Radiology', phase: 'O' },
            { code: 'DE', name: 'Dermatology', phase: 'O' },
            
            { code: 'YO', name: 'YO', phase: 'Misc' },
            { code: 'FP', name: 'FP', phase: 'Misc' },
            { code: 'LM', name: 'LM', phase: 'Misc' },
            { code: 'FM', name: 'FM', phase: 'Misc' },
            
            { code: 'CH', name: 'Community Health', phase: 'CM' },
            { code: 'PH', name: 'Public Health', phase: 'CM' },
            { code: 'UH', name: 'Urban Health', phase: 'CM' },
            { code: 'RH', name: 'Rural Health', phase: 'CM' }
          ];
        },
        
        definePhases() {
          // Define phases and their durations
          this.phases = [
            { code: 'M', name: 'Medicine', weeks: 12 },
            { code: 'S', name: 'Surgery', weeks: 12 },
            { code: 'O', name: 'OBGY', weeks: 12 },
            { code: 'Misc', name: 'Misc', weeks: 4 },
            { code: 'CM', name: 'Community Medicine', weeks: 12 }
          ];
        },
        
        defineBatchPhases() {
          // Define phase sequences for each batch
          this.batchPhases = {
            'A': ['M', 'S', 'O', 'Misc', 'CM'],
            'B': ['S', 'O', 'Misc', 'CM', 'M'],
            'C': ['O', 'Misc', 'CM', 'M', 'S'],
            'D': ['Misc', 'CM', 'M', 'S', 'O']
          };
        },
        
        generateSchedule() {
          this.schedule = [];
          const startDate = dayjs('2025-04-01');
          
          // For each batch
          for (const batch of ['A', 'B', 'C', 'D']) {
            const batchStudents = this.students.filter(s => s.batch === batch);
            let currentDate = startDate;
            
            // For each phase in the batch's sequence
            for (const phaseCode of this.batchPhases[batch]) {
              const phase = this.phases.find(p => p.code === phaseCode);
              const phaseEndDate = currentDate.add(phase.weeks, 'week').subtract(1, 'day');
              
              // Generate rotations based on phase type
              if (phaseCode === 'M') {
                this.generateMedicinePhase(batch, batchStudents, currentDate, phaseEndDate);
              } else if (phaseCode === 'S') {
                this.generateSurgeryPhase(batch, batchStudents, currentDate, phaseEndDate);
              } else if (phaseCode === 'O') {
                this.generateOBGYPhase(batch, batchStudents, currentDate, phaseEndDate);
              } else if (phaseCode === 'Misc') {
                this.generateMiscPhase(batch, batchStudents, currentDate, phaseEndDate);
              } else if (phaseCode === 'CM') {
                this.generateCommunityMedicinePhase(batch, batchStudents, currentDate, phaseEndDate);
              }
              
              // Move to next phase
              currentDate = phaseEndDate.add(1, 'day');
            }
          }
        },
        
        generateMedicinePhase(batch, students, startDate, endDate) {
          const midpointDate = startDate.add(6, 'week').subtract(1, 'day');
          const secondHalfStartDate = midpointDate.add(1, 'day');
          
          // Split students into two groups
          const group1 = students.slice(0, 17);
          const group2 = students.slice(17);
          
          // First half: Group 1 in GM, Group 2 in rotations
          this.assignStudentsToRotation(group1, 'GM', startDate, midpointDate);
          
          // Split Group 2 into subgroups
          const subgroupA = group2.slice(0, 6);
          const subgroupB = group2.slice(6, 12);
          const subgroupC = group2.slice(12);
          
          // Assign rotations for first half
          // Group A: PY → CA → EN
          this.assignStudentsToRotation(subgroupA, 'PY', startDate, startDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupA, 'CA', startDate.add(2, 'week'), startDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupA, 'EN', startDate.add(4, 'week'), midpointDate);
          
          // Group B: CA → EN → PY
          this.assignStudentsToRotation(subgroupB, 'CA', startDate, startDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupB, 'EN', startDate.add(2, 'week'), startDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupB, 'PY', startDate.add(4, 'week'), midpointDate);
          
          // Group C: EN → PY → CA
          this.assignStudentsToRotation(subgroupC, 'EN', startDate, startDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupC, 'PY', startDate.add(2, 'week'), startDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupC, 'CA', startDate.add(4, 'week'), midpointDate);
          
          // Second half: Group 2 in GM, Group 1 in rotations
          this.assignStudentsToRotation(group2, 'GM', secondHalfStartDate, endDate);
          
          // Split Group 1 into subgroups
          const subgroupD = group1.slice(0, 6);
          const subgroupE = group1.slice(6, 12);
          const subgroupF = group1.slice(12);
          
          // Assign rotations for second half
          // Group D: PY → CA → EN
          this.assignStudentsToRotation(subgroupD, 'PY', secondHalfStartDate, secondHalfStartDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupD, 'CA', secondHalfStartDate.add(2, 'week'), secondHalfStartDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupD, 'EN', secondHalfStartDate.add(4, 'week'), endDate);
          
          // Group E: CA → EN → PY
          this.assignStudentsToRotation(subgroupE, 'CA', secondHalfStartDate, secondHalfStartDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupE, 'EN', secondHalfStartDate.add(2, 'week'), secondHalfStartDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupE, 'PY', secondHalfStartDate.add(4, 'week'), endDate);
          
          // Group F: EN → PY → CA
          this.assignStudentsToRotation(subgroupF, 'EN', secondHalfStartDate, secondHalfStartDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupF, 'PY', secondHalfStartDate.add(2, 'week'), secondHalfStartDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupF, 'CA', secondHalfStartDate.add(4, 'week'), endDate);
        },
        
        generateSurgeryPhase(batch, students, startDate, endDate) {
          const midpointDate = startDate.add(6, 'week').subtract(1, 'day');
          const secondHalfStartDate = midpointDate.add(1, 'day');
          
          // Split students into two groups
          const group1 = students.slice(0, 17);
          const group2 = students.slice(17);
          
          // First half: Group 1 in GS, Group 2 in rotations
          this.assignStudentsToRotation(group1, 'GS', startDate, midpointDate);
          
          // Split Group 2 into subgroups  'GS', startDate, midpointDate);
          
          // Split Group 2 into subgroups
          const subgroupA = group2.slice(0, 6);
          const subgroupB = group2.slice(6, 12);
          const subgroupC = group2.slice(12);
          
          // Assign rotations for first half
          // Group A: AN → OR → OP
          this.assignStudentsToRotation(subgroupA, 'AN', startDate, startDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupA, 'OR', startDate.add(2, 'week'), startDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupA, 'OP', startDate.add(4, 'week'), midpointDate);
          
          // Group B: OR → OP → AN
          this.assignStudentsToRotation(subgroupB, 'OR', startDate, startDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupB, 'OP', startDate.add(2, 'week'), startDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupB, 'AN', startDate.add(4, 'week'), midpointDate);
          
          // Group C: OP → AN → OR
          this.assignStudentsToRotation(subgroupC, 'OP', startDate, startDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupC, 'AN', startDate.add(2, 'week'), startDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupC, 'OR', startDate.add(4, 'week'), midpointDate);
          
          // Second half: Group 2 in GS, Group 1 in rotations
          this.assignStudentsToRotation(group2, 'GS', secondHalfStartDate, endDate);
          
          // Split Group 1 into subgroups
          const subgroupD = group1.slice(0, 6);
          const subgroupE = group1.slice(6, 12);
          const subgroupF = group1.slice(12);
          
          // Assign rotations for second half
          // Group D: AN → OR → OP
          this.assignStudentsToRotation(subgroupD, 'AN', secondHalfStartDate, secondHalfStartDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupD, 'OR', secondHalfStartDate.add(2, 'week'), secondHalfStartDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupD, 'OP', secondHalfStartDate.add(4, 'week'), endDate);
          
          // Group E: OR → OP → AN
          this.assignStudentsToRotation(subgroupE, 'OR', secondHalfStartDate, secondHalfStartDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupE, 'OP', secondHalfStartDate.add(2, 'week'), secondHalfStartDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupE, 'AN', secondHalfStartDate.add(4, 'week'), endDate);
          
          // Group F: OP → AN → OR
          this.assignStudentsToRotation(subgroupF, 'OP', secondHalfStartDate, secondHalfStartDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupF, 'AN', secondHalfStartDate.add(2, 'week'), secondHalfStartDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(subgroupF, 'OR', secondHalfStartDate.add(4, 'week'), endDate);
        },
        
        generateOBGYPhase(batch, students, startDate, endDate) {
          const midpointDate = startDate.add(6, 'week').subtract(1, 'day');
          const secondHalfStartDate = midpointDate.add(1, 'day');
          
          // Split students into two groups
          const group1 = students.slice(0, 17);
          const group2 = students.slice(17);
          
          // Group 1 in OB for the first half
          this.assignStudentsToRotation(group1, 'OB', startDate, midpointDate);
          
          // Split Group 2 into PE and rotation subgroups
          const peGroup = group2.slice(0, 8);
          const rotationGroup = group2.slice(8);
          
          // First half: PE group in PE, rotation group in RM/RA/DE
          this.assignStudentsToRotation(peGroup, 'PE', startDate, midpointDate);
          
          // Split rotation group into 3 subgroups
          const rmGroup = rotationGroup.slice(0, 3);
          const raGroup = rotationGroup.slice(3, 6);
          const deGroup = rotationGroup.slice(6);
          
          // Assign 2-week rotations for first half
          // First 2 weeks
          this.assignStudentsToRotation(rmGroup, 'RM', startDate, startDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(raGroup, 'RA', startDate, startDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(deGroup, 'DE', startDate, startDate.add(1, 'week').add(6, 'day'));
          
          // Second 2 weeks
          this.assignStudentsToRotation(rmGroup, 'DE', startDate.add(2, 'week'), startDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(raGroup, 'RM', startDate.add(2, 'week'), startDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(deGroup, 'RA', startDate.add(2, 'week'), startDate.add(3, 'week').add(6, 'day'));
          
          // Third 2 weeks
          this.assignStudentsToRotation(rmGroup, 'RA', startDate.add(4, 'week'), midpointDate);
          this.assignStudentsToRotation(raGroup, 'DE', startDate.add(4, 'week'), midpointDate);
          this.assignStudentsToRotation(deGroup, 'RM', startDate.add(4, 'week'), midpointDate);
          
          // Second half: Group 2 in OB, Group 1 split between PE and rotations
          this.assignStudentsToRotation(group2, 'OB', secondHalfStartDate, endDate);
          
          // Split Group 1 into PE and rotation subgroups
          const peGroup2 = group1.slice(0, 8);
          const rotationGroup2 = group1.slice(8);
          
          // Second half: PE group in PE, rotation group in RM/RA/DE
          this.assignStudentsToRotation(peGroup2, 'PE', secondHalfStartDate, endDate);
          
          // Split rotation group into 3 subgroups
          const rmGroup2 = rotationGroup2.slice(0, 3);
          const raGroup2 = rotationGroup2.slice(3, 6);
          const deGroup2 = rotationGroup2.slice(6);
          
          // Assign 2-week rotations for second half
          // First 2 weeks
          this.assignStudentsToRotation(rmGroup2, 'RM', secondHalfStartDate, secondHalfStartDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(raGroup2, 'RA', secondHalfStartDate, secondHalfStartDate.add(1, 'week').add(6, 'day'));
          this.assignStudentsToRotation(deGroup2, 'DE', secondHalfStartDate, secondHalfStartDate.add(1, 'week').add(6, 'day'));
          
          // Second 2 weeks
          this.assignStudentsToRotation(rmGroup2, 'DE', secondHalfStartDate.add(2, 'week'), secondHalfStartDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(raGroup2, 'RM', secondHalfStartDate.add(2, 'week'), secondHalfStartDate.add(3, 'week').add(6, 'day'));
          this.assignStudentsToRotation(deGroup2, 'RA', secondHalfStartDate.add(2, 'week'), secondHalfStartDate.add(3, 'week').add(6, 'day'));
          
          // Third 2 weeks
          this.assignStudentsToRotation(rmGroup2, 'RA', secondHalfStartDate.add(4, 'week'), endDate);
          this.assignStudentsToRotation(raGroup2, 'DE', secondHalfStartDate.add(4, 'week'), endDate);
          this.assignStudentsToRotation(deGroup2, 'RM', secondHalfStartDate.add(4, 'week'), endDate);
        },
        
        generateMiscPhase(batch, students, startDate, endDate) {
          // Split students into 4 groups
          const group1 = students.slice(0, 9);
          const group2 = students.slice(9, 17);
          const group3 = students.slice(17, 26);
          const group4 = students.slice(26);
          
          // Weekly rotations for 4 weeks
          for (let week = 0; week < 4; week++) {
            const weekStartDate = startDate.add(week, 'week');
            const weekEndDate = weekStartDate.add(6, 'day');
            
            // Rotate groups through YO, FP, LM, FM
            if (week % 4 === 0) {
              this.assignStudentsToRotation(group1, 'YO', weekStartDate, weekEndDate);
              this.assignStudentsToRotation(group2, 'FP', weekStartDate, weekEndDate);
              this.assignStudentsToRotation(group3, 'LM', weekStartDate, weekEndDate);
              this.assignStudentsToRotation(group4, 'FM', weekStartDate, weekEndDate);
            } else if (week % 4 === 1) {
              this.assignStudentsToRotation(group1, 'FM', weekStartDate, weekEndDate);
              this.assignStudentsToRotation(group2, 'YO', weekStartDate, weekEndDate);
              this.assignStudentsToRotation(group3, 'FP', weekStartDate, weekEndDate);
              this.assignStudentsToRotation(group4, 'LM', weekStartDate, weekEndDate);
            } else if (week % 4 === 2) {
              this.assignStudentsToRotation(group1, 'LM', weekStartDate, weekEndDate);
              this.assignStudentsToRotation(group2, 'FM', weekStartDate, weekEndDate);
              this.assignStudentsToRotation(group3, 'YO', weekStartDate, weekEndDate);
              this.assignStudentsToRotation(group4, 'FP', weekStartDate, weekEndDate);
            } else {
              this.assignStudentsToRotation(group1, 'FP', weekStartDate, weekEndDate);
              this.assignStudentsToRotation(group2, 'LM', weekStartDate, weekEndDate);
              this.assignStudentsToRotation(group3, 'FM', weekStartDate, weekEndDate);
              this.assignStudentsToRotation(group4, 'YO', weekStartDate, weekEndDate);
            }
          }
        },
        
        generateCommunityMedicinePhase(batch, students, startDate, endDate) {
          // Split students into 4 groups
          const group1 = students.slice(0, 9);
          const group2 = students.slice(9, 17);
          const group3 = students.slice(17, 26);
          const group4 = students.slice(26);
          
          // Each rotation lasts for 3 consecutive weeks
          // Total 12 weeks divided into 4 rotations of 3 weeks each
          
          // First 3 weeks
          const period1Start = startDate;
          const period1End = startDate.add(2, 'week').add(6, 'day');
          this.assignStudentsToRotation(group1, 'CH', period1Start, period1End);
          this.assignStudentsToRotation(group2, 'PH', period1Start, period1End);
          this.assignStudentsToRotation(group3, 'UH', period1Start, period1End);
          this.assignStudentsToRotation(group4, 'RH', period1Start, period1End);
          
          // Second 3 weeks
          const period2Start = period1End.add(1, 'day');
          const period2End = period2Start.add(2, 'week').add(6, 'day');
          this.assignStudentsToRotation(group1, 'RH', period2Start, period2End);
          this.assignStudentsToRotation(group2, 'CH', period2Start, period2End);
          this.assignStudentsToRotation(group3, 'PH', period2Start, period2End);
          this.assignStudentsToRotation(group4, 'UH', period2Start, period2End);
          
          // Third 3 weeks
          const period3Start = period2End.add(1, 'day');
          const period3End = period3Start.add(2, 'week').add(6, 'day');
          this.assignStudentsToRotation(group1, 'UH', period3Start, period3End);
          this.assignStudentsToRotation(group2, 'RH', period3Start, period3End);
          this.assignStudentsToRotation(group3, 'CH', period3Start, period3End);
          this.assignStudentsToRotation(group4, 'PH', period3Start, period3End);
          
          // Fourth 3 weeks
          const period4Start = period3End.add(1, 'day');
          const period4End = endDate;
          this.assignStudentsToRotation(group1, 'PH', period4Start, period4End);
          this.assignStudentsToRotation(group2, 'UH', period4Start, period4End);
          this.assignStudentsToRotation(group3, 'RH', period4Start, period4End);
          this.assignStudentsToRotation(group4, 'CH', period4Start, period4End);
        },
        
        assignStudentsToRotation(students, rotation, startDate, endDate) {
          for (const student of students) {
            this.schedule.push({
              studentId: student.id,
              rotation: rotation,
              startDate: startDate,
              endDate: endDate
            });
          }
        },
        
        // Filter functions
        getFilteredStudents() {
          let filtered = [...this.students];
          
          if (this.filters.batch !== 'all') {
            filtered = filtered.filter(s => s.batch === this.filters.batch);
          }
          
          if (this.filters.student !== 'all') {
            filtered = filtered.filter(s => s.id === this.filters.student);
          }
          
          return filtered;
        },
        
        getFilteredStudentsList() {
          this.studentViewLoading = true;
          
          // Use setTimeout to simulate loading and prevent UI freezing
          return new Promise(resolve => {
            setTimeout(() => {
              let filtered = this.getFilteredStudents();
              
              if (this.studentListSearch) {
                const search = this.studentListSearch.toLowerCase();
                filtered = filtered.filter(s => 
                  s.name.toLowerCase().includes(search) || 
                  s.regdNo.toLowerCase().includes(search)
                );
              }
              
              this.studentViewLoading = false;
              resolve(filtered);
            }, 300);
          });
        },
        
        getFilteredSubPhaseStudents() {
          if (!this.selectedRotation) return [];
          
          const today = this.getCurrentDate();
          let students = this.getStudentsInRotation(this.selectedRotation);
          
          if (this.subPhaseStudentSearch) {
            const search = this.subPhaseStudentSearch.toLowerCase();
            students = students.filter(s => 
              s.name.toLowerCase().includes(search) || 
              s.regdNo.toLowerCase().includes(search)
            );
          }
          
          return students.map(student => {
            const schedule = this.schedule.find(s => 
              s.studentId === student.id && 
              s.rotation === this.selectedRotation &&
              dayjs(s.startDate) <= today && 
              dayjs(s.endDate) >= today
            );
            
            return {
              ...student,
              startDate: schedule ? schedule.startDate : null,
              endDate: schedule ? schedule.endDate : null
            };
          });
        },
        
        getFilteredSchedule() {
          let filtered = [...this.schedule];
          
          if (this.filters.batch !== 'all') {
            const batchStudents = this.students.filter(s => s.batch === this.filters.batch).map(s => s.id);
            filtered = filtered.filter(s => batchStudents.includes(s.studentId));
          }
          
          if (this.filters.phase !== 'all') {
            const phaseRotations = this.rotations.filter(r => r.phase === this.filters.phase).map(r => r.code);
            filtered = filtered.filter(s => phaseRotations.includes(s.rotation));
          }
          
          if (this.filters.rotation !== 'all') {
            filtered = filtered.filter(s => s.rotation === this.filters.rotation);
          }
          
          if (this.filters.student !== 'all') {
            filtered = filtered.filter(s => s.studentId === this.filters.student);
          }
          
          if (this.filters.startDate && this.filters.endDate) {
            const startDate = dayjs(this.filters.startDate);
            const endDate = dayjs(this.filters.endDate);
            
            filtered = filtered.filter(s => {
              const scheduleStart = dayjs(s.startDate);
              const scheduleEnd = dayjs(s.endDate);
              
              return (scheduleStart.isBefore(endDate) || scheduleStart.isSame(endDate)) && 
                     (scheduleEnd.isAfter(startDate) || scheduleEnd.isSame(startDate));
            });
          }
          
          return filtered;
        },
        
        // Helper function to get current date (either custom or actual)
        getCurrentDate() {
          return this.customToday || dayjs();
        },
        
        // Date and view functions
        getCurrentWeekDates() {
          const dates = [];
          let currentDate = this.currentViewStartDate;
          
          for (let i = 0; i < 7; i++) {
            dates.push(currentDate.add(i, 'day'));
          }
          
          return dates;
        },
        
        isToday(date) {
          const today = this.getCurrentDate();
          return today.format('YYYY-MM-DD') === date.format('YYYY-MM-DD');
        },
        
        getStudentsForDate(date) {
          const dateStr = date.format('YYYY-MM-DD');
          const schedules = this.getFilteredSchedule().filter(s => 
            dayjs(s.startDate).format('YYYY-MM-DD') <= dateStr && 
            dayjs(s.endDate).format('YYYY-MM-DD') >= dateStr
          );
          
          return schedules.map(s => {
            const student = this.students.find(student => student.id === s.studentId);
            return {
              ...student,
              rotation: s.rotation
            };
          });
        },
        
        previousWeek() {
          this.calendarLoading = true;
          this.studentViewLoading = true;
          this.rotationViewLoading = true;
          this.batchViewLoading = true;
          
          setTimeout(() => {
            this.currentViewStartDate = this.currentViewStartDate.subtract(7, 'day');
            this.currentViewEndDate = this.currentViewEndDate.subtract(7, 'day');
            
            this.calendarLoading = false;
            this.studentViewLoading = false;
            this.rotationViewLoading = false;
            this.batchViewLoading = false;
          }, 300);
        },
        
        nextWeek() {
          this.calendarLoading = true;
          this.studentViewLoading = true;
          this.rotationViewLoading = true;
          this.batchViewLoading = true;
          
          setTimeout(() => {
            this.currentViewStartDate = this.currentViewStartDate.add(7, 'day');
            this.currentViewEndDate = this.currentViewEndDate.add(7, 'day');
            
            this.calendarLoading = false;
            this.studentViewLoading = false;
            this.rotationViewLoading = false;
            this.batchViewLoading = false;
          }, 300);
        },
        
        // Modified to set the selected date as the current date for the application
        jumpToSelectedDate() {
          if (!this.jumpToDate) return;
          
          this.calendarLoading = true;
          this.studentViewLoading = true;
          this.rotationViewLoading = true;
          this.batchViewLoading = true;
          
          setTimeout(() => {
            const selectedDate = dayjs(this.jumpToDate);
            
            // Set the selected date as the current date for the application
            this.customToday = selectedDate;
            
            // Find the start of the week for the selected date
            const weekStart = selectedDate.startOf('week');
            
            this.currentViewStartDate = weekStart;
            this.currentViewEndDate = weekStart.add(6, 'day');
            
            this.calendarLoading = false;
            this.studentViewLoading = false;
            this.rotationViewLoading = false;
            this.batchViewLoading = false;
          }, 300);
        },
        
        formatDateRange(start, end) {
          return `${start.format('MMM DD, YYYY')} - ${end.format('MMM DD, YYYY')}`;
        },
        
        formatWeekRange(start, end) {
          return `${start.format('MMM DD')} - ${end.format('MMM DD, YYYY')}`;
        },
        
        formatDate(date) {
          if (!date) return 'N/A';
          return dayjs(date).format('MMM DD, YYYY');
        },
        
        // Student and rotation functions
        getStudentName(studentId) {
          const student = this.students.find(s => s.id === studentId);
          return student ? `${student.regdNo} - ${student.name}` : studentId;
        },
        
        getRotationName(rotationCode) {
          const rotation = this.rotations.find(r => r.code === rotationCode);
          return rotation ? rotation.name : rotationCode;
        },
        
        getPhaseName(phaseCode) {
          const phase = this.phases.find(p => p.code === phaseCode);
          return phase ? phase.name : phaseCode;
        },
        
        getStudentRotationForDate(studentId, date) {
          const dateStr = date.format('YYYY-MM-DD');
          
          return this.schedule.find(s => 
            s.studentId === studentId && 
            dayjs(s.startDate).format('YYYY-MM-DD') <= dateStr && 
            dayjs(s.endDate).format('YYYY-MM-DD') >= dateStr
          );
        },
        
        getStudentRotationForWeek(studentId, weekStartDate) {
          // Get the middle of the week to find the rotation
          const midWeekDate = weekStartDate.add(3, 'day');
          return this.getStudentRotationForDate(studentId, midWeekDate);
        },
        
        getCurrentRotationForStudent(studentId) {
          const today = this.getCurrentDate();
          const rotation = this.schedule.find(s => 
            s.studentId === studentId && 
            dayjs(s.startDate) <= today && 
            dayjs(s.endDate) >= today
          );
          
          return rotation || { rotation: 'None', startDate: null, endDate: null };
        },
        
        getNextRotationForStudent(studentId) {
          const today = this.getCurrentDate();
          const futureRotations = this.schedule
            .filter(s => s.studentId === studentId && dayjs(s.startDate) > today)
            .sort((a, b) => dayjs(a.startDate) - dayjs(b.startDate));
          
          return futureRotations.length > 0 ? futureRotations[0] : null;
        },
        
        // Updated to properly handle all rotations, especially in OBGY phase
        getFullScheduleForStudent(studentId) {
          if (!studentId) return [];
          
          const studentSchedule = this.schedule
            .filter(s => s.studentId === studentId)
            .sort((a, b) => dayjs(a.startDate) - dayjs(b.startDate));
          
          const startDate = dayjs('2025-04-01');
          const weeks = [];
          const today = this.getCurrentDate();
          
          // Generate 53 weeks of data
          for (let week = 0; week < 53; week++) {
            const weekStartDate = startDate.add(week, 'week');
            const weekEndDate = weekStartDate.add(6, 'day');
            
            // Check each day of the week to find rotations
            // This ensures we don't miss any short rotations that might not include the middle of the week
            let foundRotation = null;
            
            for (let day = 0; day <= 6; day++) {
              const checkDate = weekStartDate.add(day, 'day');
              const dayRotation = this.schedule.find(s => 
                s.studentId === studentId && 
                dayjs(s.startDate) <= checkDate && 
                dayjs(s.endDate) >= checkDate
              );
              
              if (dayRotation) {
                foundRotation = dayRotation;
                break;
              }
            }
            
            if (foundRotation) {
              const rotationPhase = this.rotations.find(r => r.code === foundRotation.rotation)?.phase || '';
              
              weeks.push({
                weekNumber: week + 1,
                dateRange: this.formatDateRange(weekStartDate, weekEndDate),
                rotation: foundRotation.rotation,
                phase: rotationPhase,
                isCurrentWeek: today >= weekStartDate && today <= weekEndDate
              });
            } else {
              weeks.push({
                weekNumber: week + 1,
                dateRange: this.formatDateRange(weekStartDate, weekEndDate),
                rotation: 'N/A',
                phase: '',
                isCurrentWeek: today >= weekStartDate && today <= weekEndDate
              });
            }
          }
          
          return weeks;
        },
        
        getFullScheduleByPhase(studentId) {
          const fullSchedule = this.getFullScheduleForStudent(studentId);
          const scheduleByPhase = {};
          
          // Group weeks by phase
          fullSchedule.forEach(week => {
            if (week.phase) {
              if (!scheduleByPhase[week.phase]) {
                scheduleByPhase[week.phase] = [];
              }
              scheduleByPhase[week.phase].push(week);
            } else if (week.rotation !== 'N/A') {
              if (!scheduleByPhase['Other']) {
                scheduleByPhase['Other'] = [];
              }
              scheduleByPhase['Other'].push(week);
            }
          });
          
          return scheduleByPhase;
        },
        
        getStudentsInRotation(rotationCode) {
          const today = this.getCurrentDate();
          const rotationSchedules = this.getFilteredSchedule().filter(s => 
            s.rotation === rotationCode && 
            dayjs(s.startDate) <= today && 
            dayjs(s.endDate) >= today
          );
          
          return rotationSchedules.map(s => this.students.find(student => student.id === s.studentId))
            .filter(s => s !== undefined);
        },
        
        // Updated to include all rotations in the Rotations tab
        getAllRotations() {
          const today = this.getCurrentDate();
          const allRotations = [];
          
          // Include all rotations, even if no students are currently assigned
          for (const rotation of this.rotations) {
            const students = this.getFilteredSchedule().filter(s => 
              s.rotation === rotation.code && 
              dayjs(s.startDate) <= today && 
              dayjs(s.endDate) >= today
            );
            
            if (students.length > 0) {
              allRotations.push({
                id: rotation.code,
                code: rotation.code,
                name: rotation.name,
                phase: rotation.phase,
                studentCount: students.length,
                startDate: students[0].startDate,
                endDate: students[0].endDate
              });
            } else {
              // Include rotations with no students
              allRotations.push({
                id: rotation.code,
                code: rotation.code,
                name: rotation.name,
                phase: rotation.phase,
                studentCount: 0,
                startDate: today.toDate(),
                endDate: today.add(1, 'week').toDate()
              });
            }
          }
          
          // Sort by phase and then by code
          return allRotations.sort((a, b) => {
            if (a.phase !== b.phase) return a.phase.localeCompare(b.phase);
            return a.code.localeCompare(b.code);
          });
        },
        
        // Keep the original getActiveRotations for the dashboard
        getActiveRotations() {
          const today = this.getCurrentDate();
          const activeRotations = [];
          
          for (const rotation of this.rotations) {
            const students = this.getFilteredSchedule().filter(s => 
              s.rotation === rotation.code && 
              dayjs(s.startDate) <= today && 
              dayjs(s.endDate) >= today
            );
            
            if (students.length > 0) {
              activeRotations.push({
                id: rotation.code,
                code: rotation.code,
                name: rotation.name,
                phase: rotation.phase,
                studentCount: students.length,
                startDate: students[0].startDate,
                endDate: students[0].endDate
              });
            }
          }
          
          return activeRotations;
        },
        
        getActiveRotationsCount() {
          return this.getActiveRotations().length;
        },
        
        // Batch and phase functions
        getCurrentPhaseForBatch(batch) {
          const today = this.getCurrentDate();
          const batchStudents = this.students.filter(s => s.batch === batch).map(s => s.id);
          
          const currentRotations = this.schedule.filter(s => 
            batchStudents.includes(s.studentId) && 
            dayjs(s.startDate) <= today && 
            dayjs(s.endDate) >= today
          );
          
          if (currentRotations.length === 0) {
            return { phase: 'None', startDate: null, endDate: null };
          }
          
          const rotationCodes = currentRotations.map(r => r.rotation);
          const phases = new Set();
          
          for (const code of rotationCodes) {
            const rotation = this.rotations.find(r => r.code === code);
            if (rotation) {
              phases.add(rotation.phase);
            }
          }
          
          const phase = Array.from(phases)[0];
          const phaseRotations = this.schedule.filter(s => 
            batchStudents.includes(s.studentId) && 
            this.rotations.find(r => r.code === s.rotation && r.phase === phase)
          );
          
          const startDates = phaseRotations.map(r => dayjs(r.startDate));
          const endDates = phaseRotations.map(r => dayjs(r.endDate));
          
          return {
            phase,
            startDate: startDates.reduce((a, b) => a.isBefore(b) ? a : b).toDate(),
            endDate: endDates.reduce((a, b) => a.isAfter(b) ? a : b).toDate()
          };
        },
        
        getNextPhaseForBatch(batch) {
          const currentPhase = this.getCurrentPhaseForBatch(batch);
          if (currentPhase.phase === 'None') return null;
          
          const phaseSequence = this.batchPhases[batch];
          const currentIndex = phaseSequence.indexOf(currentPhase.phase);
          
          if (currentIndex === phaseSequence.length - 1) {
            return null;
          }
          
          return { phase: phaseSequence[currentIndex + 1] };
        },
        
        getStudentCountInBatch(batch) {
          return this.students.filter(s => s.batch === batch).length;
        },
        
        // Stats functions
        getCurrentWeek() {
          const startDate = dayjs('2025-04-01');
          const today = this.getCurrentDate();
          return Math.ceil(today.diff(startDate, 'day') / 7);
        },
        
        getCompletionPercentage() {
          const startDate = dayjs('2025-04-01');
          const endDate = startDate.add(52, 'week');
          const today = this.getCurrentDate();
          
          const totalDays = endDate.diff(startDate, 'day');
          const daysPassed = today.diff(startDate, 'day');
          
          return Math.min(100, Math.max(0, Math.round((daysPassed / totalDays) * 100)));
        },
        
        // UI helper functions
        getRotationColorClass(rotation) {
          const colorMap = {
            // Medicine phase
            'GM': 'bg-blue-100 text-blue-800',
            'PY': 'bg-blue-100 text-blue-800',
            'CA': 'bg-blue-100 text-blue-800',
            'EN': 'bg-blue-100 text-blue-800',
            
            // Surgery phase
            'GS': 'bg-green-100 text-green-800',
            'AN': 'bg-green-100 text-green-800',
            'OR': 'bg-green-100 text-green-800',
            'OP': 'bg-green-100 text-green-800',
            
            // OBGY phase
            'OB': 'bg-purple-100 text-purple-800',
            'PE': 'bg-purple-100 text-purple-800',
            'RM': 'bg-purple-100 text-purple-800',
            'RA': 'bg-purple-100 text-purple-800',
            'DE': 'bg-purple-100 text-purple-800',
            
            // Misc phase
            'YO': 'bg-yellow-100 text-yellow-800',
            'FP': 'bg-yellow-100 text-yellow-800',
            'LM': 'bg-yellow-100 text-yellow-800',
            'FM': 'bg-yellow-100 text-yellow-800',
            
            // Community Medicine phase
            'CH': 'bg-red-100 text-red-800',
            'PH': 'bg-red-100 text-red-800',
            'UH': 'bg-red-100 text-red-800',
            'RH': 'bg-red-100 text-red-800'
          };
          
          return colorMap[rotation] || 'bg-gray-100 text-gray-800';
        },
        
        // Filter actions
        toggleFilters() {
          this.showFilters = !this.showFilters;
        },
        
        selectStudent(studentId) {
          this.filters.student = studentId;
          this.studentSearchQuery = '';
          this.studentSearchResults = [];
        },
        
        applyFilters() {
          this.calendarLoading = true;
          this.studentViewLoading = true;
          this.rotationViewLoading = true;
          this.batchViewLoading = true;
          
          setTimeout(() => {
            this.calendarLoading = false;
            this.studentViewLoading = false;
            this.rotationViewLoading = false;
            this.batchViewLoading = false;
          }, 300);
        },
        
        resetFilters() {
          this.filters = {
            batch: 'all',
            phase: 'all',
            rotation: 'all',
            student: 'all',
            startDate: dayjs('2025-04-01').format('YYYY-MM-DD'),
            endDate: dayjs('2025-04-01').add(52, 'week').format('YYYY-MM-DD')
          };
          
          this.studentSearchQuery = '';
          this.studentSearchResults = [];
          this.studentListSearch = '';
          
          this.calendarLoading = true;
          this.studentViewLoading = true;
          this.rotationViewLoading = true;
          this.batchViewLoading = true;
          
          setTimeout(() => {
            this.calendarLoading = false;
            this.studentViewLoading = false;
            this.rotationViewLoading = false;
            this.batchViewLoading = false;
          }, 300);
        },
        
        // Modal functions
        viewFullSchedule(studentId) {
          this.selectedStudentId = studentId;
          this.showFullScheduleModal = true;
        },
        
        viewStudentsInRotation(rotationCode) {
          this.selectedRotation = rotationCode;
          this.subPhaseStudentSearch = '';
          this.showSubPhaseStudentsModal = true;
        },
        
        viewBatchStudents(batch) {
          this.filters.batch = batch;
          this.viewType = 'student';
          this.studentListSearch = '';
        },
        
        // Export functions
        exportToCSV() {
          const data = this.getFilteredSchedule().map(s => {
            const student = this.students.find(student => student.id === s.studentId);
            return {
              RegdNo: student?.regdNo || '',
              StudentName: student?.name || '',
              Batch: student?.batch || '',
              Rotation: s.rotation,
              RotationName: this.getRotationName(s.rotation),
              Phase: this.rotations.find(r => r.code === s.rotation)?.phase || '',
              PhaseName: this.getPhaseName(this.rotations.find(r => r.code === s.rotation)?.phase || ''),
              StartDate: dayjs(s.startDate).format('YYYY-MM-DD'),
              EndDate: dayjs(s.endDate).format('YYYY-MM-DD')
            };
          });
          
          const csv = Papa.unparse(data);
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          
          const link = document.createElement('a');
          link.setAttribute('href', url);
          link.setAttribute('download', 'medical_rotation_schedule.csv');
          link.style.visibility = 'hidden';
          
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },
        
        exportStudentScheduleToCSV(studentId) {
          const fullSchedule = this.getFullScheduleForStudent(studentId);
          const student = this.students.find(s => s.id === studentId);
          
          const data = fullSchedule.map(week => ({
            RegdNo: student?.regdNo || '',
            StudentName: student?.name || '',
            Batch: student?.batch || '',
            Week: week.weekNumber,
            DateRange: week.dateRange,
            Rotation: week.rotation,
            RotationName: this.getRotationName(week.rotation),
            Phase: week.phase,
            PhaseName: this.getPhaseName(week.phase)
          }));
          
          const csv = Papa.unparse(data);
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          
          const link = document.createElement('a');
          link.setAttribute('href', url);
          link.setAttribute('download', `student_${student?.regdNo || studentId}_schedule.csv`);
          link.style.visibility = 'hidden';
          
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },
        
        printSchedule() {
          window.print();
        },

        prepareAndExportToCSV() {
          this.showExportLoadingModal = true;
          
          // Use setTimeout to allow the loading modal to render
          setTimeout(() => {
            try {
              const data = this.getFilteredSchedule().map(s => {
                const student = this.students.find(student => student.id === s.studentId);
                const rotation = this.rotations.find(r => r.code === s.rotation);
                
                return {
                  "Registration Number": student?.regdNo || '',
                  "Student Name": student?.name || '',
                  "Batch": student?.batch || '',
                  "Rotation Code": s.rotation,
                  "Rotation Name": this.getRotationName(s.rotation),
                  "Phase": rotation?.phase || '',
                  "Phase Name": this.getPhaseName(rotation?.phase || ''),
                  "Start Date": dayjs(s.startDate).format('YYYY-MM-DD'),
                  "End Date": dayjs(s.endDate).format('YYYY-MM-DD'),
                  "Duration (Days)": dayjs(s.endDate).diff(dayjs(s.startDate), 'day') + 1
                };
              });
              
              // Sort data by batch, then by student name
              data.sort((a, b) => {
                if (a.Batch !== b.Batch) return a.Batch.localeCompare(b.Batch);
                return a["Student Name"].localeCompare(b["Student Name"]);
              });
              
              const csv = Papa.unparse(data);
              const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
              const url = URL.createObjectURL(blob);
              
              const link = document.createElement('a');
              link.setAttribute('href', url);
              link.setAttribute('download', `medical_rotation_schedule_${dayjs().format('YYYY-MM-DD')}.csv`);
              link.style.visibility = 'hidden';
              
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              // Hide loading modal after export is complete
              setTimeout(() => {
                this.showExportLoadingModal = false;
              }, 500);
            } catch (error) {
              console.error('Error exporting data:', error);
              this.showExportLoadingModal = false;
              alert('An error occurred while exporting data. Please try again.');
            }
          }, 800);
        },
      };
    }
  </script>
</body>
</html>
